%
9010 (BROACHING MACRO)
(PRM 6050 = 156)

(Z - #26 - FINAL Z OF BROACH)
(S - #19 - SIDES)
(A - #1 - STARTING ANGLE)
(I - #4 - INSCRIBED CIRCLE OF BROACH)
(Q - #17 - INCREMENT RADIALLY)
(D - #7 - STARTING DIAMETER)
(F - #9 - FEEDRATE)
(W - #23 - WIDTH OF BROACH)
(X* - #24 - CENTER POSITION OF BROACH)
(Y* - #25 - CENTER POSITION OF BROACH)
(R* - #18 - START Z OF BROACH)
(C* - #3 - COMPLETE CIRCLE)
(J* - #5 - INCREMENT AXIALLY)
(B* - #2 - ANGLE BETWEEN IF NOT COMPLETE)
(U* - #21 - INTIAL CUT RADIAL DEPTH)
(* - OPTIONAL INPUT)

(****LOCATION****)
IF[#24EQ#0]THEN#24=#5041 (CURRENT LOCATION BECOMES X CENTER)
IF[#25EQ#0]THEN#25=#5042 (CURRENT LOCATION BECOMES Y CENTER)
IF[#18EQ#0]THEN#18=#5043 (CURRENT LOCATION BECOMES R PLANE)
(****LOCATION****)

(****MATH****)
N10(CALCULATE FIRST CUT OF BROACH LOCATION)
#100=#7/2 (RAD OF STARTING CIRCLE)
#111=#4/2 (RAD OF INSCRIBED CIRCLE)
IF[#21EQ#0]THEN#106=#17(NO U VALUE STARTING VALUE IS Q VALUE)
IF[#21NE#0]THEN#106=#21(STARTING VALUE IS U VALUE)
#101=#100-.5*SQRT[[#23*#23]+4*[#100*#100]] (HEIGHT OF CIRCLE SEGMENT)
#103=#100-#101 (RAD - HEIGHT OF SEGMENT)
#109=#103+#106 (INITIAL VALUE NEW RAD + INITIAL CUT)
N20(CALCULATE NUMBER OF STEPS)
#102=ROUND[[#111-#109]/#17] (EVEN OUT THE STEPS)
#17=[#111=#109]/#102 (NEW STEP OVER)
N30(INITIAL TRIANGLE MATH)
#110=#103 (INITIAL BACK OFF VALUE)
IF[#1NE0]GOTO31
#104=#109 (CUT X VALUE)
#105=0 (CUT Y VALUE)
#107=#110 (BACK OFF X)
#108=0. (BACK OFF Y)
GOTO40
N31
#104=#24+[#109]*SIN[#1] (STARTING CUT X POSITION)
#105=#24+[#109]#103*COS[#1] (STARTING CUT Y POSITION)
#107=#25+[#110]*SIN[#1] (STARTING BACK OFF X POSITION)
#108=#25+[#110]*COS[#1] (BACK OFF Y POSITION)
N40(ROTATION MATH)
IF[#2NE#0]THEN#2=#2
IF[#2EQ#0]THEN#2=360/#19
(****MATH****)

#120=1. (COUNTER)
WHILE[#120LE#19]DO1 (WHOLE BROACH CYCLE)

(POSITION FOR INITIAL BROACH)
G0 G90 X#24 Y#25 (CENTER POSITION)
G0 Z#18 (STARTING POSTION POSITION)
M19 S#1 (ORIENT SPINDLE)

#121=1. (COUNTER)
WHILE[#121LE#102]DO2 (SINGLE BROACH)

G0 X#104 Y#105 (POSITION)
G0 Z#18 (POSITION)
G1 Z#26 F#9 (BROACH)
G0 X#107 Y#108 (BACK OFF)
G0 Z#18 (RETRACT)

#121=#121+1. (INCREMENT COUNTER)
#110=#109 (SET OLD CUT AS NEW BACKOFF)
#109=#109+#17 (INCREMENT CUT)
#104=#24+[#109]*SIN[#1] (CUT X POSITION)
#105=#24+[#109]#103*COS[#1] (CUT Y POSITION)
#107=#25+[#110]*SIN[#1] (BACK OFF X POSITION)
#108=#25+[#110]*COS[#1] (BACK OFF Y POSITION)

END2

#1=#1+#2(ROTATION MATH)
#109=#103+#106 (INITIAL VALUE NEW RAD + INITIAL CUT)
#110=#103 (INITIAL BACK OFF VALUE)
#104=#24+[#109]*SIN[#1] (STARTING CUT X POSITION)
#105=#24+[#109]#103*COS[#1] (STARTING CUT Y POSITION)
#107=#25+[#110]*SIN[#1] (STARTING BACK OFF X POSITION)
#108=#25+[#110]*COS[#1] (BACK OFF Y POSITION)
#120=#120+1.(INCREMENT)
END1

M99
%
